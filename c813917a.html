<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"klcc.cc","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="简单介绍">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL主从复制">
<meta property="og:url" content="https://klcc.cc/c813917a.html">
<meta property="og:site_name" content="klcc">
<meta property="og:description" content="简单介绍">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://klcc-img-1251900471.cos.ap-chengdu.myqcloud.com/img/ApDem6.jpg">
<meta property="article:published_time" content="2021-12-28T07:34:34.968Z">
<meta property="article:modified_time" content="2021-12-28T08:08:52.287Z">
<meta property="article:author" content="klcc">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://klcc-img-1251900471.cos.ap-chengdu.myqcloud.com/img/ApDem6.jpg">


<link rel="canonical" href="https://klcc.cc/c813917a.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://klcc.cc/c813917a.html","path":"c813917a.html","title":"MySQL主从复制"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL主从复制 | klcc</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?725ad6b586949dd6e89c022fb8d748f7"></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">klcc</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">20</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">14</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">88</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">简单介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">2.</span> <span class="nav-text">搭建主从复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">主从复制原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84%E6%96%87%E4%BB%B6%E5%8F%8A%E7%BA%BF%E7%A8%8B"><span class="nav-number">3.0.1.</span> <span class="nav-text">涉及到的文件及线程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86-1"><span class="nav-number">3.0.2.</span> <span class="nav-text">主从复制原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9B%91%E6%8E%A7%E4%BF%A1%E6%81%AF"><span class="nav-number">4.</span> <span class="nav-text">主从复制监控信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E5%A4%84%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">主从故障分析处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">主从延时原因分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%B6%E6%97%B6%E4%BB%8E%E5%BA%93"><span class="nav-number">7.</span> <span class="nav-text">延时从库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%A4%8D%E5%88%B6"><span class="nav-number">8.</span> <span class="nav-text">过滤复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="nav-number">9.</span> <span class="nav-text">半同步复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GTID%E5%A4%8D%E5%88%B6"><span class="nav-number">10.</span> <span class="nav-text">GTID复制</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="klcc"
      src="/images/head.jpg">
  <p class="site-author-name" itemprop="name">klcc</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">88</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://klcc.cc/c813917a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpg">
      <meta itemprop="name" content="klcc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="klcc">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL主从复制
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
  
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-12-28 15:34:34 / 修改时间：16:08:52" itemprop="dateCreated datePublished" datetime="2021-12-28T15:34:34+08:00">2021-12-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h3><span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 简介</span><br><span class="line">1.基于二进制日志复制的</span><br><span class="line">2.主库的修改操作会记录二进制日志</span><br><span class="line">3.从库会请求新的二进制日志并回放,最终达到主从数据同步</span><br><span class="line">4.主从复制核心功能:</span><br><span class="line">  辅助备份,处理物理损坏                   </span><br><span class="line">  扩展新型的架构:高可用,高性能,分布式架构等</span><br><span class="line">  </span><br><span class="line"># 前提</span><br><span class="line">1.两台以上mysql实例 ,server_id,server_uuid不同</span><br><span class="line">2.主库开启二进制日志</span><br><span class="line">3.专用的复制用户</span><br><span class="line">4.保证主从开启之前的某个时间点,从库数据是和主库一致</span><br><span class="line">5.告知从库,复制user,passwd,IP port,以及复制起点(change master to)</span><br><span class="line">6.线程(三个):Dump thread  IO thread  SQL thread 开启(start slave)</span><br></pre></td></tr></table></figure>

<h3 id="搭建主从复制"><a href="#搭建主从复制" class="headerlink" title="搭建主从复制"></a>搭建主从复制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 环境准备</span></span><br><span class="line">cat /etc/hosts</span><br><span class="line">192.168.0.12  db2</span><br><span class="line">192.168.0.13  db3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主机角色分配</span></span><br><span class="line">db2做主库</span><br><span class="line">db3做从库</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搭建数据库，两台机器参考最开始的二进制搭建，注意目录的权限</span></span><br><span class="line"><span class="comment"># 配置文件 server_id 不能相同 db2 是7 db3是8</span></span><br><span class="line">cat /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/usr/<span class="built_in">local</span>/mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=7</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">autocommit=0</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">log_error=/data/mysql/data/mysql.log</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=<span class="literal">true</span></span><br><span class="line">slow_query_log=1</span><br><span class="line">slow_query_log_file=/data/mysql/data/slow.log</span><br><span class="line">long_query_time=0.1</span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 两台都启动数据库</span></span><br><span class="line">service mysqld start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 两台检查server_id</span></span><br><span class="line">select @@server_id;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 两台检查二进制日志开启情况</span></span><br><span class="line">show variables like <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主库db2创建复制用户</span></span><br><span class="line">grant replication slave on *.* to repl@<span class="string">&#x27;192.168.0.%&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">select user, host from mysql.user;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主库db2模拟一点数据</span></span><br><span class="line">create database <span class="built_in">test</span> charset utf8mb4;</span><br><span class="line">use <span class="built_in">test</span>;</span><br><span class="line">create table t1 (id int);</span><br><span class="line">insert into t1 values (11),(22),(33);</span><br><span class="line">commit;</span><br><span class="line">select * from t1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># db2主库进行全备</span></span><br><span class="line">mysqldump -A -R -E --master-data=2 --triggers --single-transaction &gt; /tmp/full.sql</span><br><span class="line">scp -rp /tmp/full.sql  db3:/tmp  <span class="comment"># 推送到db3从库的 /tmp 目录中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># db3恢复主库的全备数据</span></span><br><span class="line"><span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line"><span class="built_in">source</span> /tmp/full.sql;</span><br><span class="line"></span><br><span class="line"><span class="comment"># db2需要告诉从库的复制信息</span></span><br><span class="line"><span class="comment"># db2主库上查看帮助命令</span></span><br><span class="line">mysql&gt; <span class="built_in">help</span> change master to</span><br><span class="line"><span class="comment"># 得到相应模板，修改即可</span></span><br><span class="line"><span class="comment"># 需要的信息在 mysqldump 备份文件中能查看到</span></span><br><span class="line">vim /tmp/full.sql</span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000001&#x27;</span>, MASTER_LOG_POS=1048;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在db3从库中执行</span></span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=<span class="string">&#x27;192.168.0.12&#x27;</span>,</span><br><span class="line">  MASTER_USER=<span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">  MASTER_PASSWORD=<span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">  MASTER_LOG_POS=1048,</span><br><span class="line">  MASTER_CONNECT_RETRY=10;</span><br><span class="line"></span><br><span class="line"><span class="comment"># db3从库启动主从线程</span></span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果上面信息错误而且执行了使用以下办法</span></span><br><span class="line">stop slve;</span><br><span class="line">reset slave all;</span><br><span class="line">change master to...</span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查主从情况 db3从库执行</span></span><br><span class="line">show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 192.168.0.12</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 10</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 1048</span><br><span class="line">               Relay_Log_File: db3-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes  <span class="comment"># 基本状态</span></span><br><span class="line">            Slave_SQL_Running: Yes  <span class="comment"># 基本状态</span></span><br><span class="line">                         ......</span><br></pre></td></tr></table></figure>

<h3 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h3><h5 id="涉及到的文件及线程"><a href="#涉及到的文件及线程" class="headerlink" title="涉及到的文件及线程"></a>涉及到的文件及线程</h5>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 文件</span><br><span class="line">主库: binlog</span><br><span class="line">从库:</span><br><span class="line">  relay-log          # 中继日志</span><br><span class="line">  master.info        # 主库信息记录日志</span><br><span class="line">  relay-log.info     # 记录中继应用情况信息</span><br><span class="line"></span><br><span class="line"># 线程</span><br><span class="line">主库:</span><br><span class="line">  binlog_dump_thread  # 二进制日志投递线程</span><br><span class="line">  show processlist;  # 可以查看到 Binlog Dump</span><br><span class="line">从库:</span><br><span class="line">  IO_Thread  # 从库IO线程，请求和接收binlog</span><br><span class="line">  SQL_Thread  # 从库SQL线程，回放日志</span><br></pre></td></tr></table></figure>

<h5 id="主从复制原理-1"><a href="#主从复制原理-1" class="headerlink" title="主从复制原理"></a>主从复制原理</h5>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. change master to 时，ip pot user password binlog position写入到master.info进行记录</span><br><span class="line">2. start slave 时，从库会启动IO线程和SQL线程</span><br><span class="line">3. IO_T，读取master.info信息，获取主库信息连接主库</span><br><span class="line">4. 主库会生成一个准备binlog DUMP线程，来响应从库</span><br><span class="line">5. IO_T根据master.info记录的binlog文件名和position号，请求主库DUMP最新日志</span><br><span class="line">6. DUMP线程检查主库的binlog日志，如果有新的，TP(传送)给从从库的IO_T</span><br><span class="line">7. IO_T将收到的日志存储到了TCP/IP 缓存，立即返回ACK给主库 ，主库工作完成</span><br><span class="line">8. IO_T将缓存中的数据，存储到relay-log日志文件,更新master.info文件binlog 文件名和postion，IO_T工作完成</span><br><span class="line">9. SQL_T读取relay-log.info文件，获取到上次执行到的relay-log的位置，作为起点，回放relay-log</span><br><span class="line">10.SQL_T回放完成之后，会更新relay-log.info文件。</span><br><span class="line">11.relay-log会有自动清理的功能。</span><br><span class="line"></span><br><span class="line">细节：</span><br><span class="line">1.主库一旦有新的日志生成，会发送“信号”给binlog dump ，IO线程再请求</span><br></pre></td></tr></table></figure>
<p>  <img src="https://klcc-img-1251900471.cos.ap-chengdu.myqcloud.com/img/ApDem6.jpg" alt="ApDem6"></p>
<h3 id="主从复制监控信息"><a href="#主从复制监控信息" class="headerlink" title="主从复制监控信息"></a>主从复制监控信息</h3>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># 主从监控</span><br><span class="line">    # 主库</span><br><span class="line">    # 查看连接情况，每个从库都会有一行dump相关的信息</span><br><span class="line">    show processlist;</span><br><span class="line"></span><br><span class="line">		# 从库</span><br><span class="line">		show slave status \G</span><br><span class="line">	  </span><br><span class="line">	  # 详细信息说明: </span><br><span class="line">        # 主库的信息(master.info)</span><br><span class="line">        Master_Host: 192.168.0.12          # 主库的IP</span><br><span class="line">        Master_User: repl                  # 复制用户名</span><br><span class="line">        Master_Port: 3306                  # 主库的端口</span><br><span class="line">        Connect_Retry: 10                  # 断连之后的重试次数</span><br><span class="line">        Master_Log_File: mysql-bin.000001  # 已经获取到的binlog的文件名</span><br><span class="line">        Read_Master_Log_Pos: 1301          # 已经获取到的binlog的位置号</span><br><span class="line">        </span><br><span class="line">        # 从库 relay-log.info 信息</span><br><span class="line">        Relay_Log_File: db3-relay-bin.000002  # 从库已经运行过的relaylog的文件名</span><br><span class="line">        Relay_Log_Pos: 573                    # 从库已经运行过的relaylog的位置点</span><br><span class="line">        </span><br><span class="line">        # 从库复制线程工作状态</span><br><span class="line">        Slave_IO_Running: Yes</span><br><span class="line">        Slave_SQL_Running: Yes</span><br><span class="line">        </span><br><span class="line">        # 过滤复制相关的状态</span><br><span class="line">        Replicate_Do_DB:</span><br><span class="line">        Replicate_Ignore_DB:</span><br><span class="line">        Replicate_Do_Table:</span><br><span class="line">        Replicate_Ignore_Table:</span><br><span class="line">        Replicate_Wild_Do_Table:</span><br><span class="line">        Replicate_Wild_Ignore_Table:</span><br><span class="line">        </span><br><span class="line">        # 从库延时主库的时间(非人为)</span><br><span class="line">        Seconds_Behind_Master: 0  # 从库延时主库的时间(单位为秒)</span><br><span class="line">        </span><br><span class="line">        # 延时从库有关状态</span><br><span class="line">        SQL_Delay: 0              # 延时从库设定的时间</span><br><span class="line">        SQL_Remaining_Delay: NULL # 延时操作剩余时间</span><br><span class="line">        </span><br><span class="line">        # 从库线程报错详细信息</span><br><span class="line">        Last_IO_Errno: 0         # IO报错的号码</span><br><span class="line">        Last_IO_Error:           # IO报错的具体信息</span><br><span class="line">        Last_SQL_Errno: 0        # SQL报错的号码</span><br><span class="line">        Last_SQL_Error:          # SQL报错具体信息</span><br><span class="line">        </span><br><span class="line">        # GTID复制信息</span><br><span class="line">        Retrieved_Gtid_Set:      # 接收的GTID的个数</span><br><span class="line">        Executed_Gtid_Set:       # 执行的GTID的个数</span><br><span class="line">        Auto_Position: 0</span><br></pre></td></tr></table></figure>





<h3 id="主从故障分析处理"><a href="#主从故障分析处理" class="headerlink" title="主从故障分析处理"></a>主从故障分析处理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接主库</span></span><br><span class="line">(1) 用户 密码  IP  port</span><br><span class="line">	Last_IO_Error: error reconnecting to master <span class="string">&#x27;repl@10.0.0.51:3307&#x27;</span> - retry-time: 10  retries: 7</span><br><span class="line">	ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;db01&#x27;</span> (using password: YES)</span><br><span class="line">  原因:密码错误、用户错误、地址错误、端口</span><br><span class="line">		  skip_name_resolve</span><br><span class="line">		  ERROR 2003 (HY000): Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span>10.0.0.52<span class="string">&#x27; (113)</span></span><br><span class="line"><span class="string">	处理方法:</span></span><br><span class="line"><span class="string">		stop  slave  </span></span><br><span class="line"><span class="string">		reset slave all </span></span><br><span class="line"><span class="string">		change master to </span></span><br><span class="line"><span class="string">		start slave</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">(2) 主库连接数上线,或者是主库太繁忙</span></span><br><span class="line"><span class="string">	show slave  staus \G </span></span><br><span class="line"><span class="string">	Last_IO_Errno: 1040</span></span><br><span class="line"><span class="string">  Last_IO_Error: error reconnecting to master &#x27;</span>repl@10.0.0.51:3307<span class="string">&#x27; - retry-time: 10  retries: 7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	处理思路:</span></span><br><span class="line"><span class="string">		拿复制用户,手工连接一下: mysql -urepl -p123 -h 10.0.0.51 -P 3307 </span></span><br><span class="line"><span class="string">		ERROR 1040 (HY000): Too many connections</span></span><br><span class="line"><span class="string">	处理方法:</span></span><br><span class="line"><span class="string">			set global max_connections=300;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(3)防火墙,网络不通</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 请求二进制日志</span></span><br><span class="line"><span class="string">	主库缺失日志</span></span><br><span class="line"><span class="string">	从库方面,二进制日志位置点不对</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last_IO_Error: Got fatal error 1236 from master when reading data from binary log: &#x27;</span>could not find next <span class="built_in">log</span>; the first event <span class="string">&#x27;mysql-bin.000001&#x27;</span> at 154, the last event <span class="built_in">read</span> from <span class="string">&#x27;/data/3307/data/mysql-bin.000002&#x27;</span> at 154, the last byte <span class="built_in">read</span> from <span class="string">&#x27;/data/3307/data/mysql-bin.000002&#x27;</span> at 154.<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意: 在主从复制环境中,严令禁止主库中reset master; 可以选择expire 进行定期清理主库二进制日志</span></span><br><span class="line"><span class="string">解决方案: 重新构建主从</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># SQL 线程故障</span></span><br><span class="line"><span class="string">(1)读写relay-log.info </span></span><br><span class="line"><span class="string">(2)relay-log损坏,断节,找不到</span></span><br><span class="line"><span class="string">(3)接收到的SQL无法执行</span></span><br><span class="line"><span class="string">	0. SQL_MODE影响</span></span><br><span class="line"><span class="string">	1.要创建的数据库对象,已经存在</span></span><br><span class="line"><span class="string">	2.要删除或修改的对象不存在	</span></span><br><span class="line"><span class="string">	3.DML语句不符合表定义及约束时.</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">归根揭底的原因都是由于从库发生了写入操作</span></span><br><span class="line"><span class="string">Last_SQL_Error: Error &#x27;</span>Can<span class="string">&#x27;t create database &#x27;</span>db<span class="string">&#x27;; database exists&#x27;</span> on query. Default database: <span class="string">&#x27;db&#x27;</span>. Query: <span class="string">&#x27;create database db&#x27;</span></span><br><span class="line"></span><br><span class="line">以下是有风险的操作:处理方法(以从库为核心的处理方案)：</span><br><span class="line">stop slave; </span><br><span class="line"><span class="built_in">set</span> global sql_slave_skip_counter = 1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将同步指针向下移动一个，如果多次不同步，可以重复操作</span></span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line">/etc/my.cnf</span><br><span class="line">slave-skip-errors = 1032,1062,1007</span><br><span class="line"></span><br><span class="line">1007:对象已存在</span><br><span class="line">1032:无法执行DML</span><br><span class="line">1062:主键冲突,或约束冲突</span><br><span class="line"></span><br><span class="line">但是，以上操作有时是有风险的，最安全的做法就是重新构建主从，把握一个原则,一切以主库为主</span><br><span class="line">一劳永逸的方法:可以设置从库只读</span><br><span class="line">show variables like <span class="string">&#x27;%read_only%&#x27;</span>;</span><br></pre></td></tr></table></figure>




<h3 id="主从延时原因分析"><a href="#主从延时原因分析" class="headerlink" title="主从延时原因分析"></a>主从延时原因分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 从库延时主库的时间</span><br><span class="line">Seconds_Behind_Master: 0   # 从库延时主库的时间（秒为单位）</span><br><span class="line"></span><br><span class="line"># 主库方面：</span><br><span class="line">  1.日志写入不及时，解决参数(双一标准): sync_binlog=1;</span><br><span class="line">  2.主库并发业务较高，使用分布式架构</span><br><span class="line">  4.从库太多，使用级联主从</span><br><span class="line">  </span><br><span class="line">对于Classic Replication: 主库是有能力并发运行事务的，但是在Dump_T在传输日志的时候，是以事件为单元传输日志的，所以导致事务的传输工作是串行方式的，这时在主库TPS很高时，会产生比较大的主从延时</span><br><span class="line">解决办法: group commit</span><br><span class="line">从5.6开始加入了GTID，在复制时，可以将原来串行的传输模式变成并行的，除了GTID支持，还需要双一保证</span><br><span class="line"></span><br><span class="line"># 从库方面	</span><br><span class="line">Classic Replication</span><br><span class="line">SQL 线程只有一个，所以说只能串行执行relay的事务</span><br><span class="line">可以多加几个SQL线程</span><br><span class="line"></span><br><span class="line">在5.6中出现了database级别的多线程SQL </span><br><span class="line">只能针对不同库下的事务，才能并发</span><br><span class="line">到5.7版本加入了MTS ，真正实现了事务级别的并发SQL</span><br></pre></td></tr></table></figure>

<h3 id="延时从库"><a href="#延时从库" class="headerlink" title="延时从库"></a>延时从库</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"># 数据损坏 </span><br><span class="line">  物理损坏</span><br><span class="line">  逻辑损坏</span><br><span class="line">  对于传统的主从复制，比较擅长处理物理损坏</span><br><span class="line">  </span><br><span class="line"># 设计理念</span><br><span class="line">  对SQL线程进行延时设置 </span><br><span class="line"></span><br><span class="line"># 延时多久合适</span><br><span class="line">  一般企业，延时3-6小时</span><br><span class="line"></span><br><span class="line"># 如何设置</span><br><span class="line">stop slave;</span><br><span class="line">CHANGE MASTER TO MASTER_DELAY = 300;</span><br><span class="line">start slave;</span><br><span class="line">show slave status \G</span><br><span class="line">  ......</span><br><span class="line">  SQL_Delay: 300</span><br><span class="line">  SQL_Remaining_Delay: NULL</span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line"># 如何使用延时从库</span><br><span class="line">  # 模拟故障</span><br><span class="line">    create database  delay charset utf8mb4;</span><br><span class="line">    use delay;</span><br><span class="line">    create table t1(id int);</span><br><span class="line">    insert into t1 values(1),(2),(3);</span><br><span class="line">    commit; </span><br><span class="line">    drop database delay;</span><br><span class="line"></span><br><span class="line">  # 问题</span><br><span class="line">  1. 停止SQL线程，停止主库业务</span><br><span class="line">  2. 模拟SQL手工恢复relaylog到drop之前的位置点</span><br><span class="line">  3. 截取relaylog日志，找到起点（relay-log.info）和终点(drop 操作)</span><br><span class="line">  4. 恢复截取的日志，验证数据可用性</span><br><span class="line"></span><br><span class="line">  # 开始处理</span><br><span class="line">  1. 停从库的SQL线程 </span><br><span class="line">  		stop slave sql_thread;</span><br><span class="line"></span><br><span class="line">  2. 找relaylog的起点和终点</span><br><span class="line">      # 起点</span><br><span class="line">      Relay_Log_File: db01-relay-bin.000002</span><br><span class="line">      Relay_Log_Pos: 476</span><br><span class="line"></span><br><span class="line">      # 终点</span><br><span class="line">      show relaylog events in &#x27;db01-relay-bin.000002&#x27;</span><br><span class="line">      | db01-relay-bin.000002 | 1149 | Query          |         7 |        2036 | drop database delay  </span><br><span class="line"></span><br><span class="line">  3. 截取日志 </span><br><span class="line">  mysqlbinlog --start-position=476 --stop-position=1149 /data/3308/data/db01-relay-bin.000002 &gt;/tmp/relay.sql</span><br><span class="line"></span><br><span class="line">  4. 恢复 </span><br><span class="line">  set sql_log_bin=0;</span><br><span class="line">  source /tmp/relay.sql</span><br></pre></td></tr></table></figure>





<h3 id="过滤复制"><a href="#过滤复制" class="headerlink" title="过滤复制"></a>过滤复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 主库(有弊端)</span><br><span class="line">show master status;</span><br><span class="line">binlog_do_db</span><br><span class="line">binlog_ignore_db </span><br><span class="line"></span><br><span class="line"># 从库</span><br><span class="line">show slave status\G</span><br><span class="line">  # 库级别</span><br><span class="line">  Replicate_Do_DB:</span><br><span class="line">  Replicate_Ignore_DB:</span><br><span class="line"></span><br><span class="line">  # 表级别</span><br><span class="line">  Replicate_Do_Table:</span><br><span class="line">  Replicate_Ignore_Table:</span><br><span class="line"></span><br><span class="line">  # 模糊匹配</span><br><span class="line">  Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">  </span><br><span class="line"># 实现: 只需要复制xyz库的数据到从库</span><br><span class="line">  vim /etc/my.cnf</span><br><span class="line">  [mysqld]</span><br><span class="line">  ...</span><br><span class="line">  replicate_do_db=xyz</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  #  检查</span><br><span class="line">  show slave status\G</span><br><span class="line">  Replicate_Do_DB: xyz</span><br></pre></td></tr></table></figure>

<h3 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a>半同步复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">解决主从数据一致性问题</span><br><span class="line"></span><br><span class="line"># 原理</span><br><span class="line">1. 主库执行新的事务,commit时,更新 show master  status\G ,触发一个信号给</span><br><span class="line">2. binlog dump 接收到主库的 show master status\G信息,通知从库日志更新了</span><br><span class="line">3. 从库IO线程请求新的二进制日志事件</span><br><span class="line">4. 主库会通过dump线程传送新的日志事件,给从库IO线程</span><br><span class="line">5. 从库IO线程接收到binlog日志,当日志写入到磁盘上的relaylog文件时,给主库ACK_receiver线程</span><br><span class="line">6. ACK_receiver线程触发一个事件,告诉主库commit可以成功了</span><br><span class="line">7. 如果ACK达到了我们预设值的超时时间,半同步复制会切换为原始的异步复制</span><br><span class="line"></span><br><span class="line"># 配置</span><br><span class="line"># 加载插件</span><br><span class="line">  主:</span><br><span class="line">  INSTALL PLUGIN rpl_semi_sync_master SONAME &#x27;semisync_master.so&#x27;;</span><br><span class="line">  从:</span><br><span class="line">  INSTALL PLUGIN rpl_semi_sync_slave SONAME &#x27;semisync_slave.so&#x27;;</span><br><span class="line"></span><br><span class="line"># 查看是否加载成功</span><br><span class="line">  show plugins;</span><br><span class="line"></span><br><span class="line"># 启动</span><br><span class="line">  主:</span><br><span class="line">  SET GLOBAL rpl_semi_sync_master_enabled = 1;</span><br><span class="line">  从:</span><br><span class="line">  SET GLOBAL rpl_semi_sync_slave_enabled = 1;</span><br><span class="line"></span><br><span class="line"># 重启从库上的IO线程</span><br><span class="line">  STOP SLAVE IO_THREAD;</span><br><span class="line">  START SLAVE IO_THREAD;</span><br><span class="line"></span><br><span class="line"># 查看是否在运行</span><br><span class="line">  主:</span><br><span class="line">  show status like &#x27;Rpl_semi_sync_master_status&#x27;;</span><br><span class="line">  从:</span><br><span class="line">  show status like &#x27;Rpl_semi_sync_slave_status&#x27;;</span><br></pre></td></tr></table></figure>




<h3 id="GTID复制"><a href="#GTID复制" class="headerlink" title="GTID复制"></a><code>GTID</code>复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"># GTID介绍</span><br><span class="line">GTID(Global Transaction ID)是对于一个已提交事务的唯一编号，并且是一个全局(主从复制)唯一的编号</span><br><span class="line">它的官方定义如下：</span><br><span class="line">GTID = source_id ：transaction_id</span><br><span class="line">7E11FA47-31CA-19E1-9E56-C43AA21293967:29</span><br><span class="line">核心特性: 全局唯一,具备幂等性</span><br><span class="line"></span><br><span class="line"># 核心参数</span><br><span class="line">gtid-mode=on                        # 启用gtid类型，否则就是普通的复制架构</span><br><span class="line">enforce-gtid-consistency=true       # 强制GTID的一致性</span><br><span class="line">log-slave-updates=1                 # slave更新是否记入日志</span><br><span class="line"></span><br><span class="line"># 配置GTID复制过程</span><br><span class="line"># 主库db01配置文件</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql/</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=51</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">autocommit=0</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db01 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 从库db02配置文件</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=52</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">autocommit=0</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db02 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 从库db03配置文件</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=53</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">autocommit=0</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db03 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 初始化数据(所有节点)</span><br><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/application/mysql  --datadir=/data/mysql/data </span><br><span class="line"></span><br><span class="line"># 启动数据库</span><br><span class="line">/etc/init.d/mysqld start	</span><br><span class="line">		</span><br><span class="line"># 主库创建用户</span><br><span class="line">grant replication slave on *.* to repl@&#x27;10.0.0.%&#x27; identified by &#x27;123&#x27;;</span><br><span class="line"></span><br><span class="line"># 两个从库开启主从</span><br><span class="line">mysql -e &quot;change master to master_host=&#x27;10.0.0.51&#x27;,master_user=&#x27;repl&#x27;,master_password=&#x27;123&#x27;,MASTER_AUTO_POSITION=1;start slave;&quot;</span><br><span class="line">mysql -e &quot;show slave status \G&quot;|grep Y</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MySQL/" rel="tag"><i class="fa fa-tag"></i> MySQL</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2c2a11ca.html" rel="prev" title="MySQL备份恢复与迁移">
                  <i class="fa fa-chevron-left"></i> MySQL备份恢复与迁移
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2c9a5c07.html" rel="next" title="MySQL优化">
                  MySQL优化 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">klcc</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">468k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">7:06</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
