<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"klcc.cc","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="用户服务微服务(python)目录结构12345678mxshop_srvs└── user_srv          # 用户服务    ├── __init__.py    ├── handler    ├── logs    ├── model    ├── proto    └── settings">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务开发用户服务流程">
<meta property="og:url" content="https://klcc.cc/33232ac3.html">
<meta property="og:site_name" content="klcc">
<meta property="og:description" content="用户服务微服务(python)目录结构12345678mxshop_srvs└── user_srv          # 用户服务    ├── __init__.py    ├── handler    ├── logs    ├── model    ├── proto    └── settings">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-05-10T15:57:22.381Z">
<meta property="article:modified_time" content="2022-07-04T12:11:35.221Z">
<meta property="article:author" content="klcc">
<meta property="article:tag" content="python">
<meta property="article:tag" content="gin">
<meta property="article:tag" content="gRPC">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://klcc.cc/33232ac3.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://klcc.cc/33232ac3.html","path":"33232ac3.html","title":"微服务开发用户服务流程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>微服务开发用户服务流程 | klcc</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?725ad6b586949dd6e89c022fb8d748f7"></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">klcc</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">33</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">27</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">157</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.</span> <span class="nav-text">用户服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1-python"><span class="nav-number">1.1.</span> <span class="nav-text">微服务(python)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.1.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83"><span class="nav-number">1.1.2.</span> <span class="nav-text">创建虚拟环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.1.3.</span> <span class="nav-text">用户表设计</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-settings-settings-py"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">user_srv&#x2F;settings&#x2F;settings.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-model-models-py"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">user_srv&#x2F;model&#x2F;models.py</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E5%A4%84%E7%90%86"><span class="nav-number">1.1.4.</span> <span class="nav-text">密码处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#proto%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">1.2.</span> <span class="nav-text">proto接口定义</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#user-srv-proto-user-proto"><span class="nav-number">1.2.1.</span> <span class="nav-text">user_srv&#x2F;proto&#x2F;user.proto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97%E7%94%9F%E6%88%90%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.2.</span> <span class="nav-text">安装模块生成文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%BA%93loguru"><span class="nav-number">1.2.3.</span> <span class="nav-text">日志库loguru</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.2.4.</span> <span class="nav-text">查询所有用户接口</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-handler-user-py"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">user_srv&#x2F;handler&#x2F;user.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-server-py"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">user_srv&#x2F;server.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-tests-user-py"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">user_srv&#x2F;tests&#x2F;user.py</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA"><span class="nav-number">1.2.5.</span> <span class="nav-text">优雅退出</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-server-py-1"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">user_srv&#x2F;server.py</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E5%85%A5%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">1.2.6.</span> <span class="nav-text">传入启动参数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-server-py-2"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">user_srv&#x2F;server.py</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.2.7.</span> <span class="nav-text">基本实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-proto-user-proto-1"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">user_srv&#x2F;proto&#x2F;user.proto</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-model-models-py-1"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">user_srv&#x2F;model&#x2F;models.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-handler-user-py-1"><span class="nav-number">1.2.7.3.</span> <span class="nav-text">user_srv&#x2F;handler&#x2F;user.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-settings-settings-py-1"><span class="nav-number">1.2.7.4.</span> <span class="nav-text">user_srv&#x2F;settings&#x2F;settings.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-server-py-3"><span class="nav-number">1.2.7.5.</span> <span class="nav-text">user_srv&#x2F;server.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-srv-tests-user-py-1"><span class="nav-number">1.2.7.6.</span> <span class="nav-text">user_srv&#x2F;tests&#x2F;user.py</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web%E6%9C%8D%E5%8A%A1-go"><span class="nav-number">1.3.</span> <span class="nav-text">web服务(go)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%BA%93zap"><span class="nav-number">1.3.2.</span> <span class="nav-text">日志库zap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%86%E5%88%86gin%E5%92%8C%E5%BC%95%E5%85%A5zap"><span class="nav-number">1.3.3.</span> <span class="nav-text">拆分gin和引入zap</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#user-web-main-go"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">user-web&#x2F;main.go</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-web-router-user-go"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">user-web&#x2F;router&#x2F;user.go</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-web-initialize-router-go"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">user-web&#x2F;initialize&#x2F;router.go</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-web-initialize-logger-go"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">user-web&#x2F;initialize&#x2F;logger.go</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#user-web-api-user-go"><span class="nav-number">1.3.3.5.</span> <span class="nav-text">user-web&#x2F;api&#x2F;user.go</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8grpc%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.3.4.</span> <span class="nav-text">调用grpc服务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%A4%E5%B1%82yaml"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">两层yaml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">隔离配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E5%8A%A0%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86"><span class="nav-number">1.3.5.</span> <span class="nav-text">整体加入配置文件管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89mobile%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="nav-number">1.3.6.</span> <span class="nav-text">自定义mobile验证器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jwt%E9%9B%86%E6%88%90%E5%88%B0gin"><span class="nav-number">1.3.7.</span> <span class="nav-text">jwt集成到gin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.8.</span> <span class="nav-text">跨域问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis%E5%AD%98%E5%82%A8%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="nav-number">1.3.9.</span> <span class="nav-text">Redis存储验证码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.4.</span> <span class="nav-text">注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="nav-number">1.4.1.</span> <span class="nav-text">安装和基础使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Python-%E6%93%8D%E4%BD%9Cconsul"><span class="nav-number">1.4.2.</span> <span class="nav-text">Python 操作consul</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#go%E6%93%8D%E4%BD%9Cconsul"><span class="nav-number">1.4.3.</span> <span class="nav-text">go操作consul</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%AD%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7%E6%A3%80%E6%9F%A5%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.4.4.</span> <span class="nav-text">代码中配置监控检查接口</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEhttp"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">配置http</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEgrpc"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">配置grpc</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E7%AB%AF%E5%8F%A3"><span class="nav-number">1.4.5.</span> <span class="nav-text">动态获取端口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.4.6.</span> <span class="nav-text">grpc负载均衡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.5.</span> <span class="nav-text">nacos配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#python%E6%93%8D%E4%BD%9C"><span class="nav-number">1.5.1.</span> <span class="nav-text">python操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#go%E6%93%8D%E4%BD%9Cnacos"><span class="nav-number">1.5.2.</span> <span class="nav-text">go操作nacos</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.</span> <span class="nav-text">商品服务</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="klcc"
      src="/images/head.jpg">
  <p class="site-author-name" itemprop="name">klcc</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">157</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://klcc.cc/33232ac3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpg">
      <meta itemprop="name" content="klcc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="klcc">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微服务开发用户服务流程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
  
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-10 23:57:22" itemprop="dateCreated datePublished" datetime="2022-05-10T23:57:22+08:00">2022-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/gRPC/" itemprop="url" rel="index"><span itemprop="name">gRPC</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>30 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="用户服务"><a href="#用户服务" class="headerlink" title="用户服务"></a>用户服务</h2><h3 id="微服务-python"><a href="#微服务-python" class="headerlink" title="微服务(python)"></a>微服务(python)</h3><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mxshop_srvs</span><br><span class="line">└── user_srv          <span class="comment"># 用户服务</span></span><br><span class="line">    ├── __init__.py</span><br><span class="line">    ├── handler</span><br><span class="line">    ├── logs</span><br><span class="line">    ├── model</span><br><span class="line">    ├── proto</span><br><span class="line">    └── settings</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h4 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv mxshop_srv</span><br></pre></td></tr></table></figure>

<h4 id="用户表设计"><a href="#用户表设计" class="headerlink" title="用户表设计"></a>用户表设计</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install peewee</span><br><span class="line">pip3 install pymysql</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-settings-settings-py"><a href="#user-srv-settings-settings-py" class="headerlink" title="user_srv/settings/settings.py"></a><code>user_srv/settings/settings.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> playhouse.pool <span class="keyword">import</span> PooledMySQLDatabase  <span class="comment"># peewee 连接池连接</span></span><br><span class="line"><span class="keyword">from</span> playhouse.shortcuts <span class="keyword">import</span> ReconnectMixin  <span class="comment"># 断开后重新连接数据库 否则会报错 mysql gone away</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReconnectMysqlDatabase</span>(<span class="params">PooledMySQLDatabase, ReconnectMixin, ABC</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MYSQL_DB = <span class="string">&quot;mxshop_user_srv&quot;</span></span><br><span class="line">MYSQL_HOST = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">MYSQL_PORT = <span class="number">3306</span></span><br><span class="line">MYSQL_USER = <span class="string">&quot;root&quot;</span></span><br><span class="line">MYSQL_PASSWORD = <span class="string">&quot;asd123...&quot;</span></span><br><span class="line">DB = ReconnectMysqlDatabase(database=MYSQL_DB, host=MYSQL_HOST, port=MYSQL_PORT, user=MYSQL_USER,</span><br><span class="line">                            password=MYSQL_PASSWORD)</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-model-models-py"><a href="#user-srv-model-models-py" class="headerlink" title="user_srv/model/models.py"></a><code>user_srv/model/models.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> user_srv.settings <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span>(<span class="params">Model</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = settings.DB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    <span class="comment"># 用户模型</span></span><br><span class="line">    GENDER_CHOICES = (</span><br><span class="line">        (<span class="string">&quot;female&quot;</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;male&quot;</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    ROLE_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">&quot;普通用户&quot;</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">&quot;管理员&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    mobile = CharField(max_length=<span class="number">11</span>, index=<span class="literal">True</span>, unique=<span class="literal">True</span>, verbose_name=<span class="string">&quot;手机号&quot;</span>)</span><br><span class="line">    password = CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">&quot;密码&quot;</span>)  <span class="comment"># 密码密文 密文不可反解</span></span><br><span class="line">    nick_name = CharField(max_length=<span class="number">20</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;昵称&quot;</span>)</span><br><span class="line">    head_url = CharField(max_length=<span class="number">200</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;头像&quot;</span>)</span><br><span class="line">    birthday = DateField(null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;生日&quot;</span>)</span><br><span class="line">    address = CharField(max_length=<span class="number">200</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;地址&quot;</span>)</span><br><span class="line">    desc = TextField(null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;个人简介&quot;</span>)</span><br><span class="line">    gender = CharField(max_length=<span class="number">6</span>, choices=GENDER_CHOICES, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;性别&quot;</span>)</span><br><span class="line">    role = IntegerField(default=<span class="number">1</span>, choices=ROLE_CHOICES, verbose_name=<span class="string">&quot;用户角色&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    settings.DB.create_tables([User])  <span class="comment"># 创建表</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="密码处理"><a href="#密码处理" class="headerlink" title="密码处理"></a>密码处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://passlib.readthedocs.io/en/stable/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">pip install passwlib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="keyword">from</span> passlib.<span class="built_in">hash</span> <span class="keyword">import</span> pbkdf2_sha256</span><br><span class="line"></span><br><span class="line">hash1 = pbkdf2_sha256.<span class="built_in">hash</span>(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(hash1)</span><br><span class="line"><span class="built_in">print</span>(pbkdf2_sha256.verify(<span class="string">&quot;123456&quot;</span>, hash1))  <span class="comment"># 校验 返回bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存入用户</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    user = User()</span><br><span class="line">    user.nick_name = <span class="string">f&quot;user<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">    user.mobile = <span class="string">f&quot;1308822955<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">    user.password = pbkdf2_sha256.<span class="built_in">hash</span>(<span class="string">&quot;admin123&quot;</span>)</span><br><span class="line">    user.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 校验用户密码</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> User.select():</span><br><span class="line">    <span class="built_in">print</span>(pbkdf2_sha256.verify(<span class="string">&quot;admin123&quot;</span>, user.password))  <span class="comment"># 返回 True </span></span><br></pre></td></tr></table></figure>

<h3 id="proto接口定义"><a href="#proto接口定义" class="headerlink" title="proto接口定义"></a><code>proto</code>接口定义</h3><h4 id="user-srv-proto-user-proto"><a href="#user-srv-proto-user-proto" class="headerlink" title="user_srv/proto/user.proto"></a><code>user_srv/proto/user.proto</code></h4><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/empty.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;../proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetUserList(PageInfo) <span class="keyword">returns</span> (UserListResonse)</span>; <span class="comment">//用户列表</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetUserByMobile(MobileRequest) <span class="keyword">returns</span> (UserInfoResponse)</span>; <span class="comment">//通过mobile查询用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetUserById(IdRequest) <span class="keyword">returns</span> (UserInfoResponse)</span>; <span class="comment">//通过id查询用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> CreateUser(CreateUserInfo) <span class="keyword">returns</span> (UserInfoResponse)</span>; <span class="comment">//添加用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> UpdateUser(UpdateUserInfo) <span class="keyword">returns</span> (google.protobuf.Empty)</span>; <span class="comment">// 更新用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> CheckPassWord (PasswordCheckInfo) <span class="keyword">returns</span> (CheckResponse)</span>; <span class="comment">//检查密码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">PasswordCheckInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> password = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> encryptedPassword = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">CheckResponse</span> </span>&#123;</span><br><span class="line">    <span class="built_in">bool</span> success = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">PageInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">uint32</span> pn = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">uint32</span> pSize = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">MobileRequest</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">IdRequest</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> id = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">CreateUserInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> nickName = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> passWord = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">UpdateUserInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> nickName = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> gender = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">uint64</span> birthDay = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">UserInfoResponse</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> passWord = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">string</span> nickName = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">uint64</span> birthDay = <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">string</span> gender = <span class="number">6</span>;</span><br><span class="line">    <span class="built_in">int32</span> role = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">UserListResonse</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> total = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">repeated</span> UserInfoResponse data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="安装模块生成文件"><a href="#安装模块生成文件" class="headerlink" title="安装模块生成文件"></a>安装模块生成文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装模块</span></span><br><span class="line">pip3 install grpcio</span><br><span class="line">pip3 install grpcio-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成文件</span></span><br><span class="line">cd user_srv/proto/</span><br><span class="line">python3 -m grpc_tools.protoc --python_out=. --grpc_python_out=. -I. user.proto</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改导入</span></span><br><span class="line">user_srv/proto/user_pb2_grpc.py 文件中 </span><br><span class="line"><span class="keyword">import</span> user_pb2 <span class="keyword">as</span> user__pb2 改为</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> user_pb2 <span class="keyword">as</span> user__pb2</span><br></pre></td></tr></table></figure>

<h4 id="日志库loguru"><a href="#日志库loguru" class="headerlink" title="日志库loguru"></a>日志库<code>loguru</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pip install loguru</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件 切割</span></span><br><span class="line">logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>, rotation=<span class="string">&quot;200 MB&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 颜色</span></span><br><span class="line">logger.debug(<span class="string">&quot;调试信息&quot;</span>)</span><br><span class="line">logger.info(<span class="string">&quot;普通信息&quot;</span>)</span><br><span class="line">logger.warning(<span class="string">&quot;警告信息&quot;</span>)</span><br><span class="line">logger.error(<span class="string">&quot;错误信息&quot;</span>)</span><br><span class="line">logger.critical(<span class="string">&quot;严重错误信息&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 装饰器</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_func</span>(<span class="params">x, y, z</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> / (x + y + z)</span><br><span class="line">my_func(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上下文比较全</span></span><br></pre></td></tr></table></figure>

<h4 id="查询所有用户接口"><a href="#查询所有用户接口" class="headerlink" title="查询所有用户接口"></a>查询所有用户接口</h4><h5 id="user-srv-handler-user-py"><a href="#user-srv-handler-user-py" class="headerlink" title="user_srv/handler/user.py"></a><code>user_srv/handler/user.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2, user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.model.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserServicer</span>(<span class="params">user_pb2_grpc.UserServicer</span>):</span></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetUserList</span>(<span class="params">self, request: user_pb2.PageInfo, context</span>):</span></span><br><span class="line">        <span class="comment"># 获取用户的列表</span></span><br><span class="line">        rsp = user_pb2.UserListResonse()</span><br><span class="line"></span><br><span class="line">        users = User.select()</span><br><span class="line">        rsp.total = users.count()</span><br><span class="line"></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        per_page_nums = <span class="number">10</span>  <span class="comment"># 每页数量</span></span><br><span class="line">        <span class="keyword">if</span> request.pSize:</span><br><span class="line">            per_page_nums = request.pSize</span><br><span class="line">        <span class="keyword">if</span> request.pn:</span><br><span class="line">            start = per_page_nums * (request.pn - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        users = users.limit(per_page_nums).offset(start)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            user_info_rsp = user_pb2.UserInfoResponse()</span><br><span class="line"></span><br><span class="line">            user_info_rsp.<span class="built_in">id</span> = user.<span class="built_in">id</span></span><br><span class="line">            user_info_rsp.passWord = user.password</span><br><span class="line">            user_info_rsp.mobile = user.mobile</span><br><span class="line">            user_info_rsp.role = user.role</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user_info_rsp.nickName:</span><br><span class="line">                user_info_rsp.nickName = user.nick_name</span><br><span class="line">            <span class="keyword">if</span> user.gender:</span><br><span class="line">                user_info_rsp.gender = user.gender</span><br><span class="line">            <span class="keyword">if</span> user.birthday:</span><br><span class="line">                user_info_rsp.birthDay = <span class="built_in">int</span>(time.mktime(user.birthday.timetuple()))</span><br><span class="line"></span><br><span class="line">            rsp.data.append(user_info_rsp)</span><br><span class="line">        <span class="keyword">return</span> rsp</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-server-py"><a href="#user-srv-server-py" class="headerlink" title="user_srv/server.py"></a><code>user_srv/server.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span>():</span></span><br><span class="line">    logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>, rotation=<span class="string">&quot;200 MB&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">&#x27;[::]:50051&#x27;</span>)</span><br><span class="line">    logger.info(<span class="string">&quot;启动服务：127.0.0.1:50051&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-tests-user-py"><a href="#user-srv-tests-user-py" class="headerlink" title="user_srv/tests/user.py"></a><code>user_srv/tests/user.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试服务</span></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc, user_pb2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTest</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 连接grpc服务器</span></span><br><span class="line">        channel = grpc.insecure_channel(<span class="string">&quot;127.0.0.1:50051&quot;</span>)</span><br><span class="line">        self.stub = user_pb2_grpc.UserStub(channel)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        rsp: user_pb2.UserInfoResponse = self.stub.GetUserList(user_pb2.PageInfo(pn=<span class="number">2</span>, pSize=<span class="number">2</span>))</span><br><span class="line">        <span class="built_in">print</span>(rsp.total)</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> rsp.data:</span><br><span class="line">            <span class="built_in">print</span>(user.mobile, user.birthDay)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    user = UserTest()</span><br><span class="line">    user.user_list()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="优雅退出"><a href="#优雅退出" class="headerlink" title="优雅退出"></a>优雅退出</h4><h5 id="user-srv-server-py-1"><a href="#user-srv-server-py-1" class="headerlink" title="user_srv/server.py"></a><code>user_srv/server.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(os.path.dirname(__file__)))</span><br><span class="line">sys.path.insert(<span class="number">0</span>, BASE_DIR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_exit</span>(<span class="params">signo, frame</span>):</span></span><br><span class="line">    logger.info(<span class="string">&quot;进程中断&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span>():</span></span><br><span class="line">    logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>, rotation=<span class="string">&quot;200 MB&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">&#x27;[::]:50051&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主进程退出信号监听</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        windows 支持的信号是有限的</span></span><br><span class="line"><span class="string">            SIGINT   ctrl+c</span></span><br><span class="line"><span class="string">            SIGTERM  kill的</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    signal.signal(signal.SIGINT, on_exit)</span><br><span class="line">    signal.signal(signal.SIGTERM, on_exit)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;启动服务：127.0.0.1:50051&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>

<h4 id="传入启动参数"><a href="#传入启动参数" class="headerlink" title="传入启动参数"></a>传入启动参数</h4><h5 id="user-srv-server-py-2"><a href="#user-srv-server-py-2" class="headerlink" title="user_srv/server.py"></a><code>user_srv/server.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--ip&#x27;</span>,</span><br><span class="line">                    nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                    <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                    default=<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;binding ip&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--port&#x27;</span>,</span><br><span class="line">                    nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                    <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                    default=<span class="number">50051</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;the listening port&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"><span class="built_in">print</span>(args)</span><br><span class="line"><span class="built_in">print</span>(args.ip, args.port)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">--ip     传入参数</span></span><br><span class="line"><span class="string">default  默认值</span></span><br><span class="line"><span class="string">help     帮助信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">运行脚本的时候可以输入 --help 查看到所需要传入的参数</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(os.path.dirname(__file__)))</span><br><span class="line">sys.path.insert(<span class="number">0</span>, BASE_DIR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_exit</span>(<span class="params">signo, frame</span>):</span></span><br><span class="line">    logger.info(<span class="string">&quot;进程中断&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span>():</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--ip&#x27;</span>,</span><br><span class="line">                        nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        default=<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;binding ip&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--port&#x27;</span>,</span><br><span class="line">                        nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                        default=<span class="number">50051</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;the listening port&quot;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="comment"># print(args)</span></span><br><span class="line">    <span class="comment"># print(args.ip, args.port)</span></span><br><span class="line"></span><br><span class="line">    logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>, rotation=<span class="string">&quot;200 MB&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">f&#x27;<span class="subst">&#123;args.ip&#125;</span>:<span class="subst">&#123;args.port&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主进程退出信号监听</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        windows 支持的信号是有限的</span></span><br><span class="line"><span class="string">            SIGINT   ctrl+c</span></span><br><span class="line"><span class="string">            SIGTERM  kill的</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    signal.signal(signal.SIGINT, on_exit)</span><br><span class="line">    signal.signal(signal.SIGTERM, on_exit)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;启动服务: <span class="subst">&#123;args.ip&#125;</span> : <span class="subst">&#123;args.port&#125;</span>&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>

<h4 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现"></a>基本实现</h4><h5 id="user-srv-proto-user-proto-1"><a href="#user-srv-proto-user-proto-1" class="headerlink" title="user_srv/proto/user.proto"></a><code>user_srv/proto/user.proto</code></h5><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/empty.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;../proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetUserList(PageInfo) <span class="keyword">returns</span> (UserListResonse)</span>; <span class="comment">//用户列表</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetUserByMobile(MobileRequest) <span class="keyword">returns</span> (UserInfoResponse)</span>; <span class="comment">//通过mobile查询用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetUserById(IdRequest) <span class="keyword">returns</span> (UserInfoResponse)</span>; <span class="comment">//通过id查询用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> CreateUser(CreateUserInfo) <span class="keyword">returns</span> (UserInfoResponse)</span>; <span class="comment">//添加用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> UpdateUser(UpdateUserInfo) <span class="keyword">returns</span> (google.protobuf.Empty)</span>; <span class="comment">// 更新用户</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> CheckPassWord (PasswordCheckInfo) <span class="keyword">returns</span> (CheckResponse)</span>; <span class="comment">//检查密码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">PasswordCheckInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> password = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> encryptedPassword = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">CheckResponse</span> </span>&#123;</span><br><span class="line">    <span class="built_in">bool</span> success = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">PageInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">uint32</span> pn = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">uint32</span> pSize = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">MobileRequest</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">IdRequest</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> id = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">CreateUserInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> nickName = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> passWord = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">UpdateUserInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> nickName = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> gender = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">uint64</span> birthDay = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">UserInfoResponse</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> passWord = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">string</span> nickName = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">uint64</span> birthDay = <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">string</span> gender = <span class="number">6</span>;</span><br><span class="line">    <span class="built_in">int32</span> role = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">UserListResonse</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> total = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">repeated</span> UserInfoResponse data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-model-models-py-1"><a href="#user-srv-model-models-py-1" class="headerlink" title="user_srv/model/models.py"></a><code>user_srv/model/models.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> user_srv.settings <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> passlib.<span class="built_in">hash</span> <span class="keyword">import</span> pbkdf2_sha256</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span>(<span class="params">Model</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = settings.DB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    <span class="comment"># 用户模型</span></span><br><span class="line">    GENDER_CHOICES = (</span><br><span class="line">        (<span class="string">&quot;female&quot;</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;male&quot;</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    ROLE_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">&quot;普通用户&quot;</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">&quot;管理员&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    mobile = CharField(max_length=<span class="number">11</span>, index=<span class="literal">True</span>, unique=<span class="literal">True</span>, verbose_name=<span class="string">&quot;手机号&quot;</span>)</span><br><span class="line">    password = CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">&quot;密码&quot;</span>)  <span class="comment"># 密码密文 密文不可反解</span></span><br><span class="line">    nick_name = CharField(max_length=<span class="number">20</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;昵称&quot;</span>)</span><br><span class="line">    head_url = CharField(max_length=<span class="number">200</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;头像&quot;</span>)</span><br><span class="line">    birthday = DateField(null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;生日&quot;</span>)</span><br><span class="line">    address = CharField(max_length=<span class="number">200</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;地址&quot;</span>)</span><br><span class="line">    desc = TextField(null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;个人简介&quot;</span>)</span><br><span class="line">    gender = CharField(max_length=<span class="number">6</span>, choices=GENDER_CHOICES, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;性别&quot;</span>)</span><br><span class="line">    role = IntegerField(default=<span class="number">1</span>, choices=ROLE_CHOICES, verbose_name=<span class="string">&quot;用户角色&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    settings.DB.create_tables([User])</span><br><span class="line">    <span class="comment"># 对称加密 非对称加密 无法知道原始密码是什么</span></span><br><span class="line">    <span class="comment"># md5</span></span><br><span class="line">    <span class="comment"># import hashlib</span></span><br><span class="line">    <span class="comment"># m = hashlib.md5()</span></span><br><span class="line">    <span class="comment"># m.update(b&quot;123456&quot;)</span></span><br><span class="line">    <span class="comment"># print(m.hexdigest())</span></span><br><span class="line">    <span class="comment"># from passlib.hash import pbkdf2_sha256</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># hash1 = pbkdf2_sha256.hash(&quot;123456&quot;)</span></span><br><span class="line">    <span class="comment"># print(hash1)</span></span><br><span class="line">    <span class="comment"># print(pbkdf2_sha256.verify(&quot;123456&quot;, hash1))</span></span><br><span class="line">    <span class="comment"># for i in range(10):</span></span><br><span class="line">    <span class="comment">#     user = User()</span></span><br><span class="line">    <span class="comment">#     user.nick_name = f&quot;user&#123;i&#125;&quot;</span></span><br><span class="line">    <span class="comment">#     user.mobile = f&quot;1308822955&#123;i&#125;&quot;</span></span><br><span class="line">    <span class="comment">#     user.password = pbkdf2_sha256.hash(&quot;admin123&quot;)</span></span><br><span class="line">    <span class="comment">#     user.save()</span></span><br><span class="line">    <span class="comment"># for user in User.select():</span></span><br><span class="line">    <span class="comment">#     print(pbkdf2_sha256.verify(&quot;admin123&quot;, user.password))</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># # 时间转换</span></span><br><span class="line">    <span class="comment"># for user in User.select():</span></span><br><span class="line">    <span class="comment">#     if user.birthday:</span></span><br><span class="line">    <span class="comment">#         print(user.birthday)</span></span><br><span class="line">    <span class="comment">#         import time</span></span><br><span class="line">    <span class="comment">#         u_time = time.mktime(user.birthday.timetuple())</span></span><br><span class="line">    <span class="comment">#         print(int(u_time))</span></span><br><span class="line">    <span class="comment">#         from datetime import date</span></span><br><span class="line">    <span class="comment">#         print(date.fromtimestamp(u_time))</span></span><br></pre></td></tr></table></figure>

<h5 id="user-srv-handler-user-py-1"><a href="#user-srv-handler-user-py-1" class="headerlink" title="user_srv/handler/user.py"></a><code>user_srv/handler/user.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> DoesNotExist</span><br><span class="line"><span class="keyword">from</span> passlib.<span class="built_in">hash</span> <span class="keyword">import</span> pbkdf2_sha256</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> empty_pb2</span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2, user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.model.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserServicer</span>(<span class="params">user_pb2_grpc.UserServicer</span>):</span></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetUserList</span>(<span class="params">self, request: user_pb2.PageInfo, context</span>):</span></span><br><span class="line">        <span class="comment"># 获取用户的列表</span></span><br><span class="line">        rsp = user_pb2.UserListResonse()</span><br><span class="line"></span><br><span class="line">        users = User.select()</span><br><span class="line">        rsp.total = users.count()</span><br><span class="line"></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        per_page_nums = <span class="number">10</span>  <span class="comment"># 每页数量</span></span><br><span class="line">        <span class="keyword">if</span> request.pSize:</span><br><span class="line">            per_page_nums = request.pSize</span><br><span class="line">        <span class="keyword">if</span> request.pn:</span><br><span class="line">            start = per_page_nums * (request.pn - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        users = users.limit(per_page_nums).offset(start)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            rsp.data.append(self._convert_user_to_rsp(user))</span><br><span class="line">        <span class="keyword">return</span> rsp</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetUserById</span>(<span class="params">self, request: user_pb2.IdRequest, context</span>):</span></span><br><span class="line">        <span class="comment"># 通过ID查询用户</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.get(User.<span class="built_in">id</span> == request.<span class="built_in">id</span>)</span><br><span class="line">            <span class="keyword">return</span> self._convert_user_to_rsp(user)</span><br><span class="line">        <span class="keyword">except</span> DoesNotExist <span class="keyword">as</span> e:</span><br><span class="line">            context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">            context.set_details(<span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetUserByMobile</span>(<span class="params">self, request: user_pb2.MobileRequest, context</span>):</span></span><br><span class="line">        <span class="comment"># 通过 mobile 查询用户</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.get(User.mobile == request.mobile)</span><br><span class="line">            <span class="keyword">return</span> self._convert_user_to_rsp(user)</span><br><span class="line">        <span class="keyword">except</span> DoesNotExist:</span><br><span class="line">            context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">            context.set_details(<span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">CreateUser</span>(<span class="params">self, request: user_pb2.CreateUserInfo, context</span>):</span></span><br><span class="line">        <span class="comment"># 新建用户</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            User.get(User.mobile == request.mobile)</span><br><span class="line">            context.set_code(grpc.StatusCode.ALREADY_EXISTS)</span><br><span class="line">            context.set_details(<span class="string">&quot;用户已经存在&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br><span class="line">        <span class="keyword">except</span> DoesNotExist:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        user = User()</span><br><span class="line">        user.nick_name = request.nickName</span><br><span class="line">        user.mobile = request.mobile</span><br><span class="line">        user.password = pbkdf2_sha256.<span class="built_in">hash</span>(request.passWord)</span><br><span class="line">        user.save()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self._convert_user_to_rsp(user)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">UpdateUser</span>(<span class="params">self, request: user_pb2.UpdateUserInfo, context</span>):</span></span><br><span class="line">        <span class="comment"># 更新用户</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.get(User.<span class="built_in">id</span> == request.<span class="built_in">id</span>)</span><br><span class="line">            user.nick_name = request.nickName</span><br><span class="line">            user.gender = request.gender</span><br><span class="line">            user.birthday = date.fromisoformat(request.birthDay)  <span class="comment"># proto 中是uint 类型 需要转换成时间</span></span><br><span class="line">            user.save()</span><br><span class="line">            <span class="keyword">return</span> empty_pb2.Empty()</span><br><span class="line">        <span class="keyword">except</span> DoesNotExist:</span><br><span class="line">            context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">            context.set_details(<span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_convert_user_to_rsp</span>(<span class="params">self, user</span>):</span></span><br><span class="line">        <span class="comment"># 将 user 的model 转换为 message 对象</span></span><br><span class="line">        user_info_rsp = user_pb2.UserInfoResponse()</span><br><span class="line">        user_info_rsp.<span class="built_in">id</span> = user.<span class="built_in">id</span></span><br><span class="line">        user_info_rsp.passWord = user.password</span><br><span class="line">        user_info_rsp.mobile = user.mobile</span><br><span class="line">        user_info_rsp.role = user.role</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user_info_rsp.nickName:</span><br><span class="line">            user_info_rsp.nickName = user.nick_name</span><br><span class="line">        <span class="keyword">if</span> user.gender:</span><br><span class="line">            user_info_rsp.gender = user.gender</span><br><span class="line">        <span class="keyword">if</span> user.birthday:</span><br><span class="line">            user_info_rsp.birthDay = <span class="built_in">int</span>(time.mktime(user.birthday.timetuple()))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user_info_rsp</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-settings-settings-py-1"><a href="#user-srv-settings-settings-py-1" class="headerlink" title="user_srv/settings/settings.py"></a><code>user_srv/settings/settings.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC</span><br><span class="line"><span class="keyword">from</span> playhouse.pool <span class="keyword">import</span> PooledMySQLDatabase  <span class="comment"># 连接池连接</span></span><br><span class="line"><span class="keyword">from</span> playhouse.shortcuts <span class="keyword">import</span> ReconnectMixin  <span class="comment"># 断开后重新连接数据库 否则会报错 mysql gone away</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReconnectMysqlDatabase</span>(<span class="params">PooledMySQLDatabase, ReconnectMixin, ABC</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MYSQL_DB = <span class="string">&quot;mxshop_user_srv&quot;</span></span><br><span class="line">MYSQL_HOST = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">MYSQL_PORT = <span class="number">3306</span></span><br><span class="line">MYSQL_USER = <span class="string">&quot;root&quot;</span></span><br><span class="line">MYSQL_PASSWORD = <span class="string">&quot;asd123...&quot;</span></span><br><span class="line">DB = ReconnectMysqlDatabase(database=MYSQL_DB, host=MYSQL_HOST, port=MYSQL_PORT, user=MYSQL_USER,</span><br><span class="line">                            password=MYSQL_PASSWORD)</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-server-py-3"><a href="#user-srv-server-py-3" class="headerlink" title="user_srv/server.py"></a><code>user_srv/server.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(os.path.dirname(__file__)))</span><br><span class="line">sys.path.insert(<span class="number">0</span>, BASE_DIR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_exit</span>(<span class="params">signo, frame</span>):</span></span><br><span class="line">    logger.info(<span class="string">&quot;进程中断&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span>():</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--ip&#x27;</span>,</span><br><span class="line">                        nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        default=<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;binding ip&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--port&#x27;</span>,</span><br><span class="line">                        nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                        default=<span class="number">50051</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;the listening port&quot;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="comment"># print(args)</span></span><br><span class="line">    <span class="comment"># print(args.ip, args.port)</span></span><br><span class="line"></span><br><span class="line">    logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>, rotation=<span class="string">&quot;200 MB&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">f&#x27;<span class="subst">&#123;args.ip&#125;</span>:<span class="subst">&#123;args.port&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主进程退出信号监听</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        windows 支持的信号是有限的</span></span><br><span class="line"><span class="string">            SIGINT   ctrl+c</span></span><br><span class="line"><span class="string">            SIGTERM  kill的</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    signal.signal(signal.SIGINT, on_exit)</span><br><span class="line">    signal.signal(signal.SIGTERM, on_exit)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;启动服务: <span class="subst">&#123;args.ip&#125;</span> : <span class="subst">&#123;args.port&#125;</span>&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>

<h5 id="user-srv-tests-user-py-1"><a href="#user-srv-tests-user-py-1" class="headerlink" title="user_srv/tests/user.py"></a><code>user_srv/tests/user.py</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试脚本</span></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc, user_pb2</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTest</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 连接grpc服务器</span></span><br><span class="line">        channel = grpc.insecure_channel(<span class="string">&quot;127.0.0.1:50051&quot;</span>)</span><br><span class="line">        self.stub = user_pb2_grpc.UserStub(channel)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        rsp: user_pb2.UserInfoResponse = self.stub.GetUserList(user_pb2.PageInfo(pn=<span class="number">2</span>, pSize=<span class="number">2</span>))</span><br><span class="line">        <span class="built_in">print</span>(rsp.total)</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> rsp.data:</span><br><span class="line">            <span class="built_in">print</span>(user.mobile, user.birthDay)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_user_by_id</span>(<span class="params">self, <span class="built_in">id</span></span>):</span></span><br><span class="line">        rsp: user_pb2.UserInfoResponse = self.stub.GetUserById(user_pb2.IdRequest(<span class="built_in">id</span>=<span class="built_in">id</span>))</span><br><span class="line">        <span class="built_in">print</span>(rsp.mobile)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_user_by_mobile</span>(<span class="params">self, mobile</span>):</span></span><br><span class="line">        rsp: user_pb2.UserInfoResponse = self.stub.GetUserByMobile(user_pb2.MobileRequest(mobile=mobile))</span><br><span class="line">        <span class="built_in">print</span>(rsp.<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">self, nick_name, mobile, password</span>):</span></span><br><span class="line">        rsp: user_pb2.UserInfoResponse = self.stub.CreateUser(user_pb2.CreateUserInfo(</span><br><span class="line">            nickName=nick_name,</span><br><span class="line">            passWord=password,</span><br><span class="line">            mobile=mobile</span><br><span class="line">        ))</span><br><span class="line">        <span class="built_in">print</span>(rsp.<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    user = UserTest()</span><br><span class="line">    <span class="comment"># user.user_list()</span></span><br><span class="line">    <span class="comment"># user.get_user_by_id(10)</span></span><br><span class="line">    <span class="comment"># user.get_user_by_mobile(&#x27;13088229550&#x27;)</span></span><br><span class="line">    user.create_user(<span class="string">&quot;lzj&quot;</span>, <span class="string">&quot;13088888888&quot;</span>, <span class="string">&quot;admin123&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="web服务-go"><a href="#web服务-go" class="headerlink" title="web服务(go)"></a><code>web</code>服务(go)</h3><h4 id="目录结构-1"><a href="#目录结构-1" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mxshop-api</span><br><span class="line">├── go.mod</span><br><span class="line">└── user-web</span><br><span class="line">    ├── api</span><br><span class="line">    ├── config</span><br><span class="line">    ├── forms</span><br><span class="line">    ├── global</span><br><span class="line">    ├── initialize</span><br><span class="line">    ├── main.go</span><br><span class="line">    ├── middlewares</span><br><span class="line">    ├── proto</span><br><span class="line">    ├── router</span><br><span class="line">    ├── utils</span><br><span class="line">    └── validator</span><br></pre></td></tr></table></figure>

<h4 id="日志库zap"><a href="#日志库zap" class="headerlink" title="日志库zap"></a>日志库<code>zap</code></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 地址 https://github.com/uber-go/zap</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 安装 go get go.uber.org/zap</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// user-web/zap_test/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;time&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logger, _ := zap.NewProduction() <span class="comment">// 生产环境 json</span></span><br><span class="line">	<span class="comment">//logger, _ := zap.NewDevelopment() // 测试环境</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> logger.Sync() <span class="comment">// flushes buffer, if any</span></span><br><span class="line">	url := <span class="string">&quot;https://klcc.cc&quot;</span></span><br><span class="line">	<span class="comment">// 运用复杂些 性能稍微高</span></span><br><span class="line">	logger.Info(<span class="string">&quot;failed to fetch URL&quot;</span>,</span><br><span class="line">		zap.String(<span class="string">&quot;url&quot;</span>, url),</span><br><span class="line">		zap.Int(<span class="string">&quot;nums&quot;</span>, <span class="number">3</span>),</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 下面的这个方式运用简单</span></span><br><span class="line">	sugar := logger.Sugar()</span><br><span class="line">	sugar.Infow(<span class="string">&quot;failed to fetch URL&quot;</span>,</span><br><span class="line">		<span class="comment">// Structured context as loosely typed key-value pairs.</span></span><br><span class="line">		<span class="string">&quot;url&quot;</span>, url,</span><br><span class="line">		<span class="string">&quot;attempt&quot;</span>, <span class="number">3</span>,</span><br><span class="line">		<span class="string">&quot;backoff&quot;</span>, time.Second,</span><br><span class="line">	)</span><br><span class="line">	sugar.Infof(<span class="string">&quot;Failed to fetch URL: %s&quot;</span>, url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出到文件中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLogger</span><span class="params">()</span> <span class="params">(*zap.Logger, error)</span></span> &#123;</span><br><span class="line">	cfg := zap.NewProductionConfig()</span><br><span class="line">	cfg.OutputPaths = []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">&quot;./myproject.log&quot;</span>,</span><br><span class="line">		<span class="string">&quot;stderr&quot;</span>,</span><br><span class="line">		<span class="string">&quot;stdout&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cfg.Build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logger, err := NewLogger()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	su := logger.Sugar()</span><br><span class="line">	<span class="keyword">defer</span> su.Sync()</span><br><span class="line">	url := <span class="string">&quot;https://klcc.cc&quot;</span></span><br><span class="line">	sugar := logger.Sugar()</span><br><span class="line">	sugar.Infow(<span class="string">&quot;failed to fetch URL&quot;</span>,</span><br><span class="line">		<span class="string">&quot;url&quot;</span>, url,</span><br><span class="line">		<span class="string">&quot;attempt&quot;</span>, <span class="number">3</span>,</span><br><span class="line">		<span class="string">&quot;backoff&quot;</span>, time.Second,</span><br><span class="line">	)</span><br><span class="line">	sugar.Infof(<span class="string">&quot;Failed to fetch URL: %s&quot;</span>, url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="拆分gin和引入zap"><a href="#拆分gin和引入zap" class="headerlink" title="拆分gin和引入zap"></a>拆分<code>gin</code>和引入zap</h4><h5 id="user-web-main-go"><a href="#user-web-main-go" class="headerlink" title="user-web/main.go"></a><code>user-web/main.go</code></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">	<span class="string">&quot;mxshop-api/user-web/initialize&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	port := <span class="number">8021</span></span><br><span class="line">	<span class="comment">// 初始化logger</span></span><br><span class="line">	initialize.InitLogger()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化 routers</span></span><br><span class="line">	Router := initialize.Routers()</span><br><span class="line">	<span class="comment">//S() 可以获取一个全局的 sugar 可以让我们自己设置一个全局的 logger S函数和L函数很有用 全局访问 logger</span></span><br><span class="line">	zap.S().Infof(<span class="string">&quot;启动服务器，端口: %d&quot;</span>, port)</span><br><span class="line">	<span class="keyword">if</span> err := Router.Run(fmt.Sprintf(<span class="string">&quot;:%d&quot;</span>, port)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		zap.S().Panic(<span class="string">&quot;启动失败: &quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="user-web-router-user-go"><a href="#user-web-router-user-go" class="headerlink" title="user-web/router/user.go"></a><code>user-web/router/user.go</code></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> router</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">	<span class="string">&quot;mxshop-api/user-web/api&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitUserRouter</span><span class="params">(Router *gin.RouterGroup)</span></span> &#123;</span><br><span class="line">	UserRouter := Router.Group(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">	zap.S().Infof(<span class="string">&quot;配置用户相关的URL&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		UserRouter.GET(<span class="string">&quot;list&quot;</span>, api.GetUserList)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="user-web-initialize-router-go"><a href="#user-web-initialize-router-go" class="headerlink" title="user-web/initialize/router.go"></a><code>user-web/initialize/router.go</code></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> initialize</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;mxshop-api/user-web/router&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Routers</span><span class="params">()</span> *<span class="title">gin</span>.<span class="title">Engine</span></span> &#123;</span><br><span class="line">	Router := gin.Default()</span><br><span class="line">	ApiGroup := Router.Group(<span class="string">&quot;/u/v1&quot;</span>)</span><br><span class="line">	router.InitUserRouter(ApiGroup)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Router</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="user-web-initialize-logger-go"><a href="#user-web-initialize-logger-go" class="headerlink" title="user-web/initialize/logger.go"></a><code>user-web/initialize/logger.go</code></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> initialize</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLogger</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 其他地方就可以只用 S()</span></span><br><span class="line">	<span class="comment">//logger, _ := zap.NewProduction()</span></span><br><span class="line">	logger, _ := zap.NewDevelopment()</span><br><span class="line">	zap.ReplaceGlobals(logger)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="user-web-api-user-go"><a href="#user-web-api-user-go" class="headerlink" title="user-web/api/user.go"></a><code>user-web/api/user.go</code></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> api</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserList</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">	ctx.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">		<span class="string">&quot;message&quot;</span>: <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="调用grpc服务"><a href="#调用grpc服务" class="headerlink" title="调用grpc服务"></a>调用grpc服务</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 配置文件管理`</span>viper<span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>使用go应用程序的完整配置解决方案<br>支持 JSON TOML YAML HCL 等<br>支持设置默认值<br>实时监控的重新读取配置文件<br>从环境中读取<br>从远程配置系统读取并监控配置变化<br>从命令行参数读取<br>从buffer读取<br>显式配置值</p>
<p><a target="_blank" rel="noopener" href="https://github.com/spf13/viper">https://github.com/spf13/viper</a></p>
<p>go get github.com/spf13/viper</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 简单配置文件</span><br><span class="line"></span><br><span class="line">`main.go`</span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;github.com/spf13/viper&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type ServerConfig struct &#123;</span><br><span class="line">	ServiceName string `mapstructure:&quot;name&quot;`</span><br><span class="line">	Port        int    `mapstructure:&quot;port&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	v := viper.New()</span><br><span class="line">	// 文件的路径如何设置</span><br><span class="line">	v.SetConfigFile(&quot;viper_test/ch01/config.yaml&quot;)</span><br><span class="line">	if err := v.ReadInConfig(); err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ServerConfig := ServerConfig&#123;&#125;</span><br><span class="line">	if err := v.Unmarshal(&amp;ServerConfig); err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(v.Get(&quot;name&quot;), v.Get(&quot;port&quot;))</span><br><span class="line">	fmt.Println(ServerConfig)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>config.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;user-web&#x27;</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">8022</span></span><br></pre></td></tr></table></figure>

<h5 id="两层yaml"><a href="#两层yaml" class="headerlink" title="两层yaml"></a>两层yaml</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MysqlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host <span class="keyword">string</span> <span class="string">`mapstructure:&quot;host&quot;`</span></span><br><span class="line">	Port <span class="keyword">int</span>    <span class="string">`mapstructure:&quot;port&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> ServerConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	ServiceName <span class="keyword">string</span>      <span class="string">`mapstructure:&quot;name&quot;`</span></span><br><span class="line">	MysqlInfo   MysqlConfig <span class="string">`mapstructure:&quot;mysql&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	v := viper.New()</span><br><span class="line">	<span class="comment">// 文件的路径如何设置</span></span><br><span class="line">	v.SetConfigFile(<span class="string">&quot;viper_test/ch02/config.yaml&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err := v.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	ServerConfig := ServerConfig&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := v.Unmarshal(&amp;ServerConfig); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(ServerConfig)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;user-web&#x27;</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<h5 id="隔离配置文件"><a href="#隔离配置文件" class="headerlink" title="隔离配置文件"></a>隔离配置文件</h5><p><code>config-pro.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;user-web&#x27;</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&#x27;10.0.0.80&#x27;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3308</span></span><br></pre></td></tr></table></figure>

<p><code>cofig-debug.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;user-web2&#x27;</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3309</span></span><br></pre></td></tr></table></figure>

<p><code>main.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MysqlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host <span class="keyword">string</span> <span class="string">`mapstructure:&quot;host&quot;`</span></span><br><span class="line">	Port <span class="keyword">int</span>    <span class="string">`mapstructure:&quot;port&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> ServerConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	ServiceName <span class="keyword">string</span>      <span class="string">`mapstructure:&quot;name&quot;`</span></span><br><span class="line">	MysqlInfo   MysqlConfig <span class="string">`mapstructure:&quot;mysql&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取环境变量的值 </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetEnvInfo</span><span class="params">(env <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	viper.AutomaticEnv()</span><br><span class="line">	<span class="keyword">return</span> viper.GetBool(env)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	debug := GetEnvInfo(<span class="string">&quot;MXSHOP_DEBUG&quot;</span>)  <span class="comment">// 调用 检查环境变量中 MXSHOP_DEBUG 的值</span></span><br><span class="line">	configFilePrefix := <span class="string">&quot;config&quot;</span></span><br><span class="line">	configFileName := fmt.Sprintf(<span class="string">&quot;viper_test/ch02/%s-pro.yaml&quot;</span>, configFilePrefix)</span><br><span class="line">	<span class="keyword">if</span> debug &#123;</span><br><span class="line">		configFileName = fmt.Sprintf(<span class="string">&quot;viper_test/ch02/%s-debug.yaml&quot;</span>, configFilePrefix)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v := viper.New()</span><br><span class="line">	v.SetConfigFile(configFileName)</span><br><span class="line">	<span class="keyword">if</span> err := v.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	ServerConfig := ServerConfig&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := v.Unmarshal(&amp;ServerConfig); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(ServerConfig)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// viper 动态监控配置变化</span></span><br><span class="line">	v.WatchConfig()</span><br><span class="line">	v.OnConfigChange(<span class="function"><span class="keyword">func</span><span class="params">(e fsnotify.Event)</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;config file changed: &quot;</span>, e.Name)</span><br><span class="line">		_ = v.ReadInConfig()</span><br><span class="line">		_ = v.Unmarshal(&amp;ServerConfig)</span><br><span class="line">		fmt.Println(ServerConfig)</span><br><span class="line">	&#125;)</span><br><span class="line">	time.Sleep(time.Second * <span class="number">300</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="整体加入配置文件管理"><a href="#整体加入配置文件管理" class="headerlink" title="整体加入配置文件管理"></a>整体加入配置文件管理</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 表单验证</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h4 id="自定义mobile验证器"><a href="#自定义mobile验证器" class="headerlink" title="自定义mobile验证器"></a>自定义<code>mobile</code>验证器</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 登录逻辑</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h4 id="jwt集成到gin"><a href="#jwt集成到gin" class="headerlink" title="jwt集成到gin"></a><code>jwt</code>集成到<code>gin</code></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/dgrijalva/jwt-go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> get github.com/dgrijalva/jwt-<span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h4 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 验证码</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br><span class="line"><span class="comment">// https://github.com/mojocn/base64Captcha</span></span><br></pre></td></tr></table></figure>

<h4 id="Redis存储验证码"><a href="#Redis存储验证码" class="headerlink" title="Redis存储验证码"></a>Redis存储验证码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/go-redis/redis</span></span><br></pre></td></tr></table></figure>



<h3 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h3><h4 id="安装和基础使用"><a href="#安装和基础使用" class="headerlink" title="安装和基础使用"></a>安装和基础使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/consul/consul</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动一个</span></span><br><span class="line">docker run -itd --name consul-web \</span><br><span class="line">-p 8500:8500 \</span><br><span class="line">-p 8300:8300 -p 8301:8301 \</span><br><span class="line">-p 8302:8302 -p 8600:8600/udp \</span><br><span class="line">consul consul agent -dev -client=0.0.0.0 \</span><br><span class="line">-enable-script-checks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">web页面</span><br><span class="line">http://10.0.0.70:8500/</span><br><span class="line"></span><br><span class="line">dns</span><br><span class="line">http://10.0.0.70:8600/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dig @10.0.0.70 -p 8600 consul.service.consul SRV</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 帮助文档</span></span><br><span class="line">https://www.consul.io/api-docs/agent/service#register-service</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注册服务</span></span><br><span class="line">curl -X PUT \</span><br><span class="line">  http://127.0.0.1:8500/v1/agent/service/register \</span><br><span class="line">  -H &#x27;content-type: application/json&#x27; \</span><br><span class="line">  -d &#x27;&#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mshop-web&quot;,</span><br><span class="line">        &quot;ID&quot;: &quot;mshop-web&quot;,</span><br><span class="line">        &quot;Tags&quot;: [&quot;mxshop&quot;, &quot;klcc&quot;, &quot;imooc&quot;, &quot;web&quot;],</span><br><span class="line">        &quot;Address&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;Port&quot;: 50051</span><br><span class="line">    &#125;&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注销 web 的服务</span></span><br><span class="line">curl -X PUT   http://127.0.0.1:8500/v1/agent/service/deregister/mshop-web   -H &#x27;content-type: application/json&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看服务列表</span></span><br><span class="line">curl http://localhost:8500/v1/agent/services</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询指定服务</span></span><br><span class="line">curl http://localhost:8500/v1/agent/services?filter=Service==web</span><br><span class="line">curl http://localhost:8500/v1/agent/services?filter=Service!=web</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看健康状态</span></span><br><span class="line">curl http://localhost:8500/v1/agent/health/service/name/mshop-web</span><br></pre></td></tr></table></figure>

<h4 id="Python-操作consul"><a href="#Python-操作consul" class="headerlink" title="Python 操作consul"></a>Python 操作consul</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;contentType&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册服务</span></span><br><span class="line"><span class="comment">#  &quot;HTTP&quot;: f&quot;http://&#123;address&#125;:&#123;port&#125;/health&quot;,</span></span><br><span class="line"><span class="comment"># &quot;GRPC&quot;: f&quot;&#123;address&#125;:&#123;port&#125;&quot;,</span></span><br><span class="line"><span class="comment"># &quot;GRPCUseTLS&quot;: False,</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">name, <span class="built_in">id</span>, address, port</span>):</span></span><br><span class="line">    url = <span class="string">&quot;http://10.0.0.70:8500/v1/agent/service/register&quot;</span></span><br><span class="line">    rsp = requests.put(url, headers=headers, json=&#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: name,</span><br><span class="line">        <span class="string">&quot;ID&quot;</span>: <span class="built_in">id</span>,</span><br><span class="line">        <span class="string">&quot;Tags&quot;</span>: [<span class="string">&quot;mxshop&quot;</span>, <span class="string">&quot;klcc&quot;</span>, <span class="string">&quot;imooc&quot;</span>, <span class="string">&quot;web&quot;</span>],</span><br><span class="line">        <span class="string">&quot;Address&quot;</span>: address,</span><br><span class="line">        <span class="string">&quot;Port&quot;</span>: port,</span><br><span class="line">        <span class="string">&quot;Check&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;HTTP&quot;</span>: <span class="string">f&quot;http://<span class="subst">&#123;address&#125;</span>:<span class="subst">&#123;port&#125;</span>/health&quot;</span>,</span><br><span class="line">            <span class="string">&quot;TimeOut&quot;</span>: <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">            <span class="string">&quot;InterVal&quot;</span>: <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">            <span class="string">&quot;DeregisterCriticalServiceAfter&quot;</span>: <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> rsp.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;注册成功&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;注册失败&quot;</span>, rsp.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注销服务</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deregister</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    url = <span class="string">f&quot;http://10.0.0.70:8500/v1/agent/service/deregister/<span class="subst">&#123;<span class="built_in">id</span>&#125;</span>&quot;</span></span><br><span class="line">    rsp = requests.put(url, headers=headers)</span><br><span class="line">    <span class="keyword">if</span> rsp.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;注销成功&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;注销失败&quot;</span>, rsp.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤服务</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_service</span>(<span class="params">name</span>):</span></span><br><span class="line">    url = <span class="string">&quot;http://10.0.0.70:8500/v1/agent/services&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;filter&quot;</span>: <span class="string">f&#x27;Service == &quot;<span class="subst">&#123;name&#125;</span>&quot;&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    rsp = requests.get(url, params=params).json()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> rsp.items():</span><br><span class="line">        <span class="built_in">print</span>(k, v)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># register(&quot;mshop-web&quot;, &quot;mshop-web&quot;, &quot;192.168.0.100&quot;, 8022)</span></span><br><span class="line">    <span class="comment"># register(&quot;mshop-srv&quot;, &quot;mshop-srv&quot;, &quot;192.168.0.100&quot;, 50051)</span></span><br><span class="line">    <span class="comment"># deregister(&quot;mshop-web&quot;)</span></span><br><span class="line">    filter_service(<span class="string">&quot;mshop-srv&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># python 第三方库 https://github.com/poppyred/python-consul2</span></span><br><span class="line"><span class="comment"># pip3 install python-consul2</span></span><br></pre></td></tr></table></figure>

<h4 id="go操作consul"><a href="#go操作consul" class="headerlink" title="go操作consul"></a>go操作consul</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hashicorp/consul/api&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">(address <span class="keyword">string</span>, port <span class="keyword">int</span>, name <span class="keyword">string</span>, tags []<span class="keyword">string</span>, id <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	cfg := api.DefaultConfig()</span><br><span class="line">	cfg.Address = <span class="string">&quot;10.0.0.70:8500&quot;</span></span><br><span class="line"></span><br><span class="line">	client, err := api.NewClient(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 生成对应的检查对象</span></span><br><span class="line">	check := &amp;api.AgentServiceCheck&#123;</span><br><span class="line">		HTTP:                           <span class="string">&quot;http://192.168.0.100:8022/health&quot;</span>,</span><br><span class="line">		Timeout:                        <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">		Interval:                       <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">		DeregisterCriticalServiceAfter: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 生成注册对象</span></span><br><span class="line">	registration := <span class="built_in">new</span>(api.AgentServiceRegistration)</span><br><span class="line">	registration.Name = name</span><br><span class="line">	registration.ID = id</span><br><span class="line">	registration.Port = port</span><br><span class="line">	registration.Tags = tags</span><br><span class="line">	registration.Address = address</span><br><span class="line">	registration.Check = check</span><br><span class="line"></span><br><span class="line">	err = client.Agent().ServiceRegister(registration)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AllServices</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cfg := api.DefaultConfig()</span><br><span class="line">	cfg.Address = <span class="string">&quot;10.0.0.70:8500&quot;</span></span><br><span class="line"></span><br><span class="line">	client, err := api.NewClient(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	data, err := client.Agent().Services()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> key, _ := <span class="keyword">range</span> data &#123;</span><br><span class="line">		fmt.Println(key)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FilterService</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cfg := api.DefaultConfig()</span><br><span class="line">	cfg.Address = <span class="string">&quot;10.0.0.70:8500&quot;</span></span><br><span class="line"></span><br><span class="line">	client, err := api.NewClient(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	data, err := client.Agent().ServicesWithFilter(<span class="string">`Service == &quot;user-web&quot;`</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> key, _ := <span class="keyword">range</span> data &#123;</span><br><span class="line">		fmt.Println(key)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//_ = Register(&quot;192.168.0.100&quot;, 8022, &quot;user-web&quot;, []string&#123;&quot;mxshop&quot;, &quot;klcc&quot;&#125;, &quot;user-web&quot;)</span></span><br><span class="line">	<span class="comment">//AllServices()</span></span><br><span class="line">	FilterService()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="代码中配置监控检查接口"><a href="#代码中配置监控检查接口" class="headerlink" title="代码中配置监控检查接口"></a>代码中配置监控检查接口</h4><h5 id="配置http"><a href="#配置http" class="headerlink" title="配置http"></a>配置<code>http</code></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Router.GET(<span class="string">&quot;/health&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">		<span class="string">&quot;code&quot;</span>:    http.StatusOK,</span><br><span class="line">		<span class="string">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="配置grpc"><a href="#配置grpc" class="headerlink" title="配置grpc"></a>配置<code>grpc</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># grpc的服务中 需要增加consul 的 proto 服务注册</span></span><br></pre></td></tr></table></figure>



<h4 id="动态获取端口"><a href="#动态获取端口" class="headerlink" title="动态获取端口"></a>动态获取端口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="grpc负载均衡"><a href="#grpc负载均衡" class="headerlink" title="grpc负载均衡"></a>grpc负载均衡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/mbobakov/grpc-consul-resolver</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;PackageTest/grpclb_test/proto&quot;</span></span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	_ <span class="string">&quot;github.com/mbobakov/grpc-consul-resolver&quot;</span> <span class="comment">// It&#x27;s important</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	conn, err := grpc.Dial(</span><br><span class="line">		<span class="string">&quot;consul://10.0.0.70:8500/user-srv?wait=14s&amp;tag=srv]&quot;</span>,</span><br><span class="line">		grpc.WithInsecure(),</span><br><span class="line">		grpc.WithDefaultServiceConfig(<span class="string">`&#123;&quot;loadBalancingPolicy&quot;: &quot;round_robin&quot;&#125;`</span>),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		userSrvClient := proto.NewUserClient(conn)</span><br><span class="line">		rsp, err := userSrvClient.GetUserList(context.Background(), &amp;proto.PageInfo&#123;</span><br><span class="line">			Pn:    <span class="number">1</span>,</span><br><span class="line">			PSize: <span class="number">2</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> index, data := <span class="keyword">range</span> rsp.Data &#123;</span><br><span class="line">			fmt.Println(index, data)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="nacos配置中心"><a href="#nacos配置中心" class="headerlink" title="nacos配置中心"></a>nacos配置中心</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https://nacos.io/zh-cn/docs/what-is-nacos.html</span><br><span class="line"></span><br><span class="line">docker run --name nacos-quick -e MODE=standalone -e JVM_XMS=512m -e JVM_XMX=512m -e JVM_XMN=256m  -p 8848:8848 -p 9848:9848 -d nacos/nacos-server:2.0.2</span><br><span class="line"></span><br><span class="line">命名空间</span><br><span class="line">组</span><br><span class="line">配置集</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://github.com/nacos-group/nacos-sdk-python</span><br><span class="line">https://github.com/nacos-group/nacos-sdk-go</span><br></pre></td></tr></table></figure>

<h4 id="python操作"><a href="#python操作" class="headerlink" title="python操作"></a>python操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nacos</span><br><span class="line"></span><br><span class="line">SERVER_ADDRESSES = <span class="string">&quot;10.0.0.70:8848&quot;</span></span><br><span class="line">NAMESPACE = <span class="string">&quot;7efaf717-319c-4637-9ae6-1a6c0931fc4c&quot;</span>  <span class="comment"># 是 namespace id</span></span><br><span class="line"></span><br><span class="line">client = nacos.NacosClient(SERVER_ADDRESSES, namespace=NAMESPACE, username=<span class="string">&quot;nacos&quot;</span>, password=<span class="string">&quot;nacos&quot;</span>)</span><br><span class="line"></span><br><span class="line">data_id = <span class="string">&quot;user-srv.json&quot;</span></span><br><span class="line">group = <span class="string">&quot;dev&quot;</span></span><br><span class="line">res = client.get_config(data_id, group)</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">data_json = json.loads(res)</span><br><span class="line"><span class="built_in">print</span>(data_json)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_cb</span>(<span class="params">args</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;配置文件产生变化&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client.add_config_watcher(data_id, group, test_cb)</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h4 id="go操作nacos"><a href="#go操作nacos" class="headerlink" title="go操作nacos"></a>go操作nacos</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/nacos-group/nacos-sdk-go/clients&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/nacos-group/nacos-sdk-go/common/constant&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/nacos-group/nacos-sdk-go/vo&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sc := []constant.ServerConfig&#123;</span><br><span class="line">		&#123;</span><br><span class="line">			IpAddr: <span class="string">&quot;10.0.0.70&quot;</span>,</span><br><span class="line">			Port:   <span class="number">8848</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	cc := constant.ClientConfig&#123;</span><br><span class="line">		NamespaceId:         <span class="string">&quot;7efaf717-319c-4637-9ae6-1a6c0931fc4c&quot;</span>, <span class="comment">// 如果需要支持多namespace，我们可以场景多个client,它们有不同的NamespaceId。当namespace是public时，此处填空字符串。</span></span><br><span class="line">		TimeoutMs:           <span class="number">5000</span>,</span><br><span class="line">		NotLoadCacheAtStart: <span class="literal">true</span>,</span><br><span class="line">		LogDir:              <span class="string">&quot;tmp/nacos/log&quot;</span>,</span><br><span class="line">		CacheDir:            <span class="string">&quot;tmp/nacos/cache&quot;</span>,</span><br><span class="line">		LogLevel:            <span class="string">&quot;debug&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	configClient, err := clients.CreateConfigClient(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;serverConfigs&quot;</span>: sc,</span><br><span class="line">		<span class="string">&quot;clientConfig&quot;</span>:  cc,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	content, err := configClient.GetConfig(vo.ConfigParam&#123;</span><br><span class="line">		DataId: <span class="string">&quot;user-web.yaml&quot;</span>,</span><br><span class="line">		Group:  <span class="string">&quot;dev&quot;</span>&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(content)</span><br><span class="line"></span><br><span class="line">	err = configClient.ListenConfig(vo.ConfigParam&#123;</span><br><span class="line">		DataId: <span class="string">&quot;user-web.yaml&quot;</span>,</span><br><span class="line">		Group:  <span class="string">&quot;dev&quot;</span>,</span><br><span class="line">		OnChange: <span class="function"><span class="keyword">func</span><span class="params">(namespace, group, dataId, data <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;配置文件产生变化&quot;</span>)</span><br><span class="line">			fmt.Println(<span class="string">&quot;group:&quot;</span> + group + <span class="string">&quot;, dataId:&quot;</span> + dataId + <span class="string">&quot;, data:&quot;</span> + data)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	time.Sleep(<span class="number">3000</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="商品服务"><a href="#商品服务" class="headerlink" title="商品服务"></a>商品服务</h2>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
              <a href="/tags/gin/" rel="tag"><i class="fa fa-tag"></i> gin</a>
              <a href="/tags/gRPC/" rel="tag"><i class="fa fa-tag"></i> gRPC</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/6d104c29.html" rel="prev" title="Gin框架">
                  <i class="fa fa-chevron-left"></i> Gin框架
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">klcc</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.4m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">21:10</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
